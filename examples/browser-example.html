<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SQL è§£æå™¨ - æµè§ˆå™¨ç¤ºä¾‹</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }

        .container {
            background: white;
            border-radius: 8px;
            padding: 30px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }

        .example-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            background-color: #fafafa;
        }

        .example-title {
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 18px;
            font-weight: bold;
        }

        textarea {
            width: 100%;
            height: 120px;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            resize: vertical;
            box-sizing: border-box;
        }

        button {
            background-color: #3498db;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            margin: 10px 5px 10px 0;
        }

        button:hover {
            background-color: #2980b9;
        }

        .result {
            margin-top: 15px;
            padding: 15px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }

        .success {
            background-color: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }

        .error {
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }

        .info {
            background-color: #d1ecf1;
            border: 1px solid #bee5eb;
            color: #0c5460;
        }

        .preset-buttons {
            margin-bottom: 10px;
        }

        .preset-btn {
            background-color: #6c757d;
            font-size: 12px;
            padding: 5px 10px;
        }

        .preset-btn:hover {
            background-color: #5a6268;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>ğŸ” SQL è§£æå™¨ - æµè§ˆå™¨ç¤ºä¾‹</h1>

        <div class="example-section">
            <div class="example-title">SQL è¯­å¥è§£æå™¨</div>
            <div class="preset-buttons">
                <button class="preset-btn" onclick="loadPreset('basic')">åŸºæœ¬æŸ¥è¯¢</button>
                <button class="preset-btn" onclick="loadPreset('join')">JOIN æŸ¥è¯¢</button>
                <button class="preset-btn" onclick="loadPreset('complex')">å¤æ‚æŸ¥è¯¢</button>
                <button class="preset-btn" onclick="loadPreset('case')">CASE è¡¨è¾¾å¼</button>
                <button class="preset-btn" onclick="loadPreset('insert')">INSERT è¯­å¥</button>
                <button class="preset-btn" onclick="loadPreset('update')">UPDATE è¯­å¥</button>
                <button class="preset-btn" onclick="loadPreset('error')">é”™è¯¯ç¤ºä¾‹</button>
            </div>
            <textarea id="sqlInput" placeholder="åœ¨è¿™é‡Œè¾“å…¥ SQL è¯­å¥...">SELECT id, name, email FROM users WHERE age > 18 ORDER
                BY name LIMIT 10</textarea>
            <div>
                <button onclick="parseSQL()">ğŸ” è§£æ SQL</button>
                <button onclick="validateSQL()">âœ… éªŒè¯ SQL</button>
                <button onclick="extractTables()">ğŸ“‹ æå–è¡¨å</button>
                <button onclick="extractColumns()">ğŸ“ æå–åˆ—å</button>
                <button onclick="analyzeSQL()">ğŸ§  æ™ºèƒ½åˆ†æ</button>
                <button onclick="clearResult()">ğŸ—‘ï¸ æ¸…ç©ºç»“æœ</button>
            </div>
            <div id="result" class="result info" style="display: none;"></div>
        </div>

        <div class="example-section">
            <div class="example-title">ğŸ“Š åŠŸèƒ½ç‰¹æ€§</div>
            <ul>
                <li><strong>æ”¯æŒçš„è¯­å¥ç±»å‹:</strong> SELECT, INSERT, UPDATE, DELETE</li>
                <li><strong>é«˜çº§ç‰¹æ€§:</strong> JOIN, å­æŸ¥è¯¢, CASE è¡¨è¾¾å¼, èšåˆå‡½æ•°</li>
                <li><strong>æ™ºèƒ½åˆ†æ:</strong> æŸ¥è¯¢æ¡ä»¶æå–, å­—æ®µä¿¡æ¯åˆ†æ, å¤æ‚åº¦è¯„ä¼°</li>
                <li><strong>é”™è¯¯å¤„ç†:</strong> è¯¦ç»†çš„è¯­æ³•é”™è¯¯ä¿¡æ¯å’Œä½ç½®å®šä½</li>
                <li><strong>å®ç”¨å·¥å…·:</strong> è¡¨åæå–, åˆ—åæå–, SQL éªŒè¯</li>
                <li><strong>AST è¾“å‡º:</strong> å®Œæ•´çš„æŠ½è±¡è¯­æ³•æ ‘ç»“æ„</li>
            </ul>
        </div>
    </div>

    <!-- å¼•å…¥æ„å»ºå¥½çš„ SQL è§£æå™¨ -->
    <script src="../dist/sql-parser.min.js"></script>

    <script>
        // é¢„è®¾çš„ SQL ç¤ºä¾‹
        const presets = {
            basic: `SELECT id, name, email, age 
FROM users 
WHERE age > 18 AND active = true 
ORDER BY name ASC 
LIMIT 10`,

            join: `SELECT u.name, u.email, p.title, p.created_at
FROM users u
LEFT JOIN posts p ON u.id = p.user_id
WHERE u.active = true
ORDER BY p.created_at DESC`,

            complex: `SELECT u.name, u.email, COUNT(o.id) as order_count, SUM(o.total) as total_spent
FROM users u
LEFT JOIN orders o ON u.id = o.user_id
WHERE u.active = true 
  AND u.created_at BETWEEN '2023-01-01' AND '2023-12-31'
  AND u.age IN (25, 30, 35, 40)
  AND u.name LIKE '%å¼ %'
GROUP BY u.id, u.name, u.email
HAVING COUNT(o.id) > 5 AND SUM(o.total) > 1000
ORDER BY total_spent DESC, order_count DESC
LIMIT 20`,

            case: `SELECT 
    name,
    age,
    CASE 
        WHEN age >= 65 THEN 'Senior'
        WHEN age >= 18 THEN 'Adult'
        WHEN age >= 13 THEN 'Teen'
        ELSE 'Child'
    END as age_group
FROM users
WHERE active = true`,

            insert: `INSERT INTO users (name, email, age, active) 
VALUES 
    ('å¼ ä¸‰', 'zhangsan@example.com', 25, true),
    ('æå››', 'lisi@example.com', 30, true)`,

            update: `UPDATE users 
SET 
    email = 'newemail@example.com',
    last_login = NOW(),
    active = true
WHERE id = 123 AND age > 18`,

            error: `SELECT * FROM WHERE age > 18` // æ•…æ„çš„è¯­æ³•é”™è¯¯
        };

        // åŠ è½½é¢„è®¾ç¤ºä¾‹
        function loadPreset(type) {
            document.getElementById('sqlInput').value = presets[type];
            clearResult();
        }

        // è§£æ SQL
        function parseSQL() {
            const sql = document.getElementById('sqlInput').value.trim();
            const resultDiv = document.getElementById('result');

            if (!sql) {
                showResult('è¯·è¾“å…¥ SQL è¯­å¥', 'error');
                return;
            }

            try {
                const result = SQLParser.parseSQL(sql,{includeComments:true});
                const output = `âœ… è§£ææˆåŠŸ!

ğŸ“‹ åŸºæœ¬ä¿¡æ¯:
- è¯­å¥ç±»å‹: ${result.ast.type}
- è§£æçŠ¶æ€: ${result.success ? 'æˆåŠŸ' : 'å¤±è´¥'}

ğŸŒ³ AST ç»“æ„:
${JSON.stringify(result.ast, null, 2)}`;

                showResult(output, 'success');
            } catch (error) {
                const output = `âŒ è§£æå¤±è´¥!

ğŸš« é”™è¯¯ä¿¡æ¯:
- é”™è¯¯ç±»å‹: ${error.type || 'PARSE_ERROR'}
- é”™è¯¯æè¿°: ${error.message}
- é”™è¯¯ä½ç½®: ç¬¬ ${error.line || '?'} è¡Œ, ç¬¬ ${error.column || '?'} åˆ—

ğŸ’¡ å»ºè®®: è¯·æ£€æŸ¥ SQL è¯­æ³•æ˜¯å¦æ­£ç¡®`;

                showResult(output, 'error');
            }
        }

        // éªŒè¯ SQL
        function validateSQL() {
            const sql = document.getElementById('sqlInput').value.trim();

            if (!sql) {
                showResult('è¯·è¾“å…¥ SQL è¯­å¥', 'error');
                return;
            }

            try {
                const result = SQLParser.validateSQL(sql);
                const output = `${result.isValid ? 'âœ…' : 'âŒ'} SQL éªŒè¯ç»“æœ: ${result.isValid ? 'æœ‰æ•ˆ' : 'æ— æ•ˆ'}

ğŸ“Š éªŒè¯è¯¦æƒ…:
- è¯­æ³•æ£€æŸ¥: ${result.isValid ? 'é€šè¿‡' : 'å¤±è´¥'}
- é”™è¯¯æ•°é‡: ${result.errors.length}

${result.errors.length > 0 ? 'ğŸš« å‘ç°çš„é”™è¯¯:\n' + result.errors.map(err => `- ${err.message} (ç¬¬${err.line}è¡Œ, ç¬¬${err.column}åˆ—)`).join('\n') : ''}`;

                showResult(output, result.isValid ? 'success' : 'error');
            } catch (error) {
                showResult(`âŒ éªŒè¯è¿‡ç¨‹å‡ºé”™: ${error.message}`, 'error');
            }
        }

        // æå–è¡¨å
        function extractTables() {
            const sql = document.getElementById('sqlInput').value.trim();

            if (!sql) {
                showResult('è¯·è¾“å…¥ SQL è¯­å¥', 'error');
                return;
            }

            try {
                const tables = SQLParser.extractTables(sql);
                const output = `ğŸ“‹ æå–åˆ°çš„è¡¨å:

ğŸ—‚ï¸ è¡¨åˆ—è¡¨ (å…± ${tables.length} ä¸ª):
${tables.length > 0 ? tables.map((table, index) => `${index + 1}. ${table}`).join('\n') : 'æœªæ‰¾åˆ°ä»»ä½•è¡¨å'}

ğŸ’¡ è¯´æ˜: åŒ…æ‹¬ä¸»è¡¨ã€JOIN è¡¨å’Œå­æŸ¥è¯¢ä¸­çš„è¡¨`;

                showResult(output, 'info');
            } catch (error) {
                showResult(`âŒ æå–è¡¨åå¤±è´¥: ${error.message}`, 'error');
            }
        }

        // æå–åˆ—å
        function extractColumns() {
            const sql = document.getElementById('sqlInput').value.trim();

            if (!sql) {
                showResult('è¯·è¾“å…¥ SQL è¯­å¥', 'error');
                return;
            }

            try {
                const columns = SQLParser.extractColumns(sql);
                const output = `ğŸ“ æå–åˆ°çš„åˆ—å:

ğŸ“Š åˆ—åˆ—è¡¨ (å…± ${columns.length} ä¸ª):
${columns.length > 0 ? columns.map((column, index) => `${index + 1}. ${column}`).join('\n') : 'æœªæ‰¾åˆ°ä»»ä½•åˆ—å'}

ğŸ’¡ è¯´æ˜: åŒ…æ‹¬é€‰æ‹©åˆ—ã€æ¡ä»¶åˆ—å’Œæ’åºåˆ—`;

                showResult(output, 'info');
            } catch (error) {
                showResult(`âŒ æå–åˆ—åå¤±è´¥: ${error.message}`, 'error');
            }
        }

        // æ™ºèƒ½åˆ†æ SQL
        function analyzeSQL() {
            const sql = document.getElementById('sqlInput').value.trim();

            if (!sql) {
                showResult('è¯·è¾“å…¥ SQL è¯­å¥', 'error');
                return;
            }

            try {
                const result = SQLParser.analyzeSQL(sql);
                
                if (!result.success) {
                    showResult(`æ™ºèƒ½åˆ†æå¤±è´¥: ${result.error}`, 'error');
                    return;
                }

                const { analysis, complexity, query } = result;

                // æ ¼å¼åŒ–æ¡ä»¶ä¿¡æ¯
                const formatConditions = (conditions) => {
                    if (!conditions || conditions.length === 0) return 'æ— ';
                    return conditions.map((cond, index) =>
                        `${index + 1}. ${cond.field} ${getOperatorText(cond.operator)} ${formatValue(cond.value)} (${cond.type})`
                    ).join('\n');
                };

                // æ ¼å¼åŒ–å­—æ®µä¿¡æ¯
                const formatFields = (fields) => {
                    if (!fields || fields.length === 0) return 'æ— ';
                    return fields.map((field, index) =>
                        `${index + 1}. ${field.name}${field.alias ? ` AS ${field.alias}` : ''}${field.table ? ` (æ¥è‡ª ${field.table})` : ''} - ${field.type}`
                    ).join('\n');
                };

                // æ ¼å¼åŒ–è¡¨ä¿¡æ¯
                const formatTables = (tables) => {
                    if (!tables || tables.length === 0) return 'æ— ';
                    return tables.map((table, index) =>
                        `${index + 1}. ${table.name}${table.alias ? ` AS ${table.alias}` : ''} - ${table.type}`
                    ).join('\n');
                };

                // æ ¼å¼åŒ–JOINä¿¡æ¯
                const formatJoins = (joins) => {
                    if (!joins || joins.length === 0) return 'æ— ';
                    return joins.map((join, index) =>
                        `${index + 1}. ${join.type} ${join.table}${join.condition ? ` ON ${join.condition}` : ''}`
                    ).join('\n');
                };

                // æ ¼å¼åŒ–æ’åºè§„åˆ™
                const formatOrderBy = (orderBy) => {
                    if (!orderBy || orderBy.length === 0) return 'æ— ';
                    return orderBy.map((order, index) =>
                        `${index + 1}. ${order.field} ${order.direction}`
                    ).join('\n');
                };

                const output = `ğŸ§  SQL æ™ºèƒ½åˆ†æç»“æœ:

ğŸ“‹ åŸºæœ¬ä¿¡æ¯:
- æŸ¥è¯¢ç±»å‹: ${query.type}
- å¤æ‚åº¦è¯„åˆ†: ${complexity.score}/10 (${complexity.level})

ğŸ” æŸ¥è¯¢æ¡ä»¶ (${analysis.conditions.length} ä¸ª):
${formatConditions(analysis.conditions)}

ğŸ“Š è¾“å‡ºå­—æ®µ (${analysis.fields.length} ä¸ª):
${formatFields(analysis.fields)}

ğŸ—‚ï¸ æ¶‰åŠè¡¨ (${analysis.tables.length} ä¸ª):
${formatTables(analysis.tables)}

ğŸ”— JOIN å…³ç³» (${analysis.joins.length} ä¸ª):
${formatJoins(analysis.joins)}

ğŸ“ˆ æ’åºè§„åˆ™ (${analysis.orderBy.length} ä¸ª):
${formatOrderBy(analysis.orderBy)}

âš¡ æ€§èƒ½ç‰¹å¾:
- å¤æ‚åº¦å› å­: ${complexity.factors.join(', ') || 'æ— '}

ğŸ’¡ å¤æ‚åº¦è¯´æ˜: ${complexity.description || 'ç®€å•æŸ¥è¯¢'}`;

                showResult(output, 'success');
            } catch (error) {
                showResult(`âŒ æ™ºèƒ½åˆ†æå¤±è´¥: ${error.message}`, 'error');
            }
        }

        // è¾…åŠ©å‡½æ•°ï¼šè·å–æ“ä½œç¬¦æ–‡æœ¬
        function getOperatorText(operator) {
            const operatorMap = {
                '=': 'ç­‰äº',
                '!=': 'ä¸ç­‰äº',
                '<>': 'ä¸ç­‰äº',
                '>': 'å¤§äº',
                '<': 'å°äº',
                '>=': 'å¤§äºç­‰äº',
                '<=': 'å°äºç­‰äº',
                'LIKE': 'åŒ…å«',
                'IN': 'åœ¨åˆ—è¡¨ä¸­',
                'BETWEEN': 'åœ¨èŒƒå›´å†…'
            };
            return operatorMap[operator] || operator;
        }

        // è¾…åŠ©å‡½æ•°ï¼šæ ¼å¼åŒ–å€¼
        function formatValue(value) {
            if (Array.isArray(value)) {
                return `[${value.join(', ')}]`;
            }
            if (typeof value === 'object' && value !== null) {
                if (value.start !== undefined && value.end !== undefined) {
                    return `${value.start} åˆ° ${value.end}`;
                }
                return JSON.stringify(value);
            }
            return String(value);
        }

        // æ˜¾ç¤ºç»“æœ
        function showResult(text, type) {
            const resultDiv = document.getElementById('result');
            resultDiv.textContent = text;
            resultDiv.className = `result ${type}`;
            resultDiv.style.display = 'block';
        }

        // æ¸…ç©ºç»“æœ
        function clearResult() {
            const resultDiv = document.getElementById('result');
            resultDiv.style.display = 'none';
            resultDiv.textContent = '';
        }

        // é¡µé¢åŠ è½½å®Œæˆåçš„åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function () {
            console.log('ğŸš€ SQL è§£æå™¨å·²åŠ è½½å®Œæˆ!');
            console.log('window.SQLParser:', window.SQLParser);
            console.log('typeof SQLParser:', typeof SQLParser);
            if (window.SQLParser) {
                console.log('å¯ç”¨çš„ API:', Object.keys(window.SQLParser));
            }
        });
    </script>
</body>

</html>